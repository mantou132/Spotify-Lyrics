{"version":3,"file":"popup.js","sources":["../src/popup/store.ts","../src/popup/elements/item.ts","../src/popup/elements/list.ts","../src/popup/elements/root.ts","../src/popup/index.ts"],"sourcesContent":["import browser from 'webextension-polyfill';\nimport { createStore, updateStore } from '@mantou/gem';\n\nimport { Event, Message } from '../common/constants';\nimport { sendMessage } from '../common/bg';\n\nimport type { Song } from '../page/lyrics';\n\nexport interface PopupStore {\n  // current track name\n  name: string;\n  // current track artists\n  artists: string;\n  // current matched lyrics track id\n  id: number;\n  // auto matched lyrics track id\n  aId: number;\n  // lyrics track list\n  list: Song[];\n}\n\nexport const store = createStore<PopupStore>({\n  name: '',\n  artists: '',\n  list: [],\n  id: 0,\n  aId: 0,\n});\n\nexport function changeSong(id: number) {\n  updateStore(store, { id });\n\n  const msg: Message<PopupStore> = {\n    type: Event.SELECT_SONG,\n    data: store,\n  };\n  sendMessage(msg);\n}\n\nexport function cancelMId() {\n  updateStore(store, { id: store.aId });\n\n  const msg: Message<PopupStore> = {\n    type: Event.SELECT_SONG,\n    data: store,\n  };\n  sendMessage(msg);\n}\n\nexport function confirmedMId() {\n  sendMessage({ type: Event.CONFIRMED_SONG });\n  setTimeout(window.close, 300);\n}\n\nbrowser.runtime.onMessage.addListener((msg: Message) => {\n  if (msg?.type === Event.SEND_SONGS) {\n    updateStore(store, msg.data);\n  }\n});\n\nsendMessage({ type: Event.GET_SONGS });\n","import { html, customElement, connectStore, GemElement, property } from '@mantou/gem';\n\nimport { store } from '../store';\n\nimport { Song } from '../../page/lyrics';\nimport { theme } from '../../common/theme';\n\n@connectStore(store)\n@customElement('app-track-item')\nexport class SongItem extends GemElement {\n  @property song: Song | undefined;\n\n  render() {\n    if (!this.song) return null;\n    const { id, name, artists, album, duration } = this.song;\n    const durationText = duration\n      ? `${Math.floor(duration / 1000 / 60)}:${(Math.floor(duration / 1000) % 60)\n          .toString()\n          .padStart(2, '0')}`\n      : '';\n    const checked = id === store.id;\n    const artist = artists.map(({ name }) => name).join(',');\n    return html`\n      <style>\n        :host {\n          display: flex;\n          align-items: center;\n          padding: 0.75rem 0.875em;\n          cursor: default;\n          background: rgba(${theme.textRGB}, 0);\n          color: rgba(${theme.textRGB}, 1);\n        }\n        .track-info {\n          line-height: 1.375;\n          flex-grow: 1;\n          display: flex;\n          flex-direction: column;\n          overflow: hidden;\n        }\n        .track-info div {\n          overflow: hidden;\n          text-overflow: ellipsis;\n          white-space: nowrap;\n        }\n        .artist-name {\n          font-size: 0.875rem;\n          color: rgba(${theme.textRGB}, 0.5);\n        }\n        .status {\n          padding-left: 1rem;\n        }\n      </style>\n      <div class=\"track-info\">\n        <div title=${name} class=\"track-name\">${name}</div>\n        <div class=\"artist-name\">\n          <span title=\"id: ${id}\">${durationText}</span>\n          • <span title=${artist}>${artist}</span> •\n          <span title=${album.name}>${album.name}</span>\n        </div>\n      </div>\n      ${checked ? html`<div class=\"status\">✓</div>` : null}\n    `;\n  }\n\n  mounted() {\n    this.effect(\n      () => {\n        if (this.song?.id === store.id) {\n          this.scrollIntoView({ behavior: 'smooth', block: 'nearest' });\n        }\n      },\n      () => [store.id],\n    );\n  }\n}\n","import { html, customElement, connectStore, GemElement } from '@mantou/gem';\n\nimport './item';\nimport { store, changeSong } from '../store';\nimport { events, sendEvent } from '../../common/ga';\nimport { getOptions } from '../../options/store';\nimport { theme } from '../../common/theme';\n\n@connectStore(store)\n@customElement('app-track-list')\nexport class SongList extends GemElement {\n  select = async (id: number) => {\n    const { cid } = await getOptions();\n    sendEvent(cid, events.selectTrack);\n    changeSong(id);\n  };\n  render() {\n    if (store.list.length === 0) {\n      return null;\n    }\n    return html`\n      <style>\n        app-track-item:hover {\n          background: rgba(${theme.textRGB}, 0.1);\n        }\n      </style>\n      ${store.list.map(\n        (song) => html`\n          <app-track-item @click=${() => this.select(song.id)} .song=${song}></app-track-item>\n        `,\n      )}\n    `;\n  }\n}\n","import { html, customElement, connectStore, GemElement } from '@mantou/gem';\n\nimport { store, changeSong, confirmedMId, cancelMId } from '../store';\nimport { events, sendEvent } from '../../common/ga';\nimport { getOptions } from '../../options/store';\nimport { theme } from '../../common/theme';\nimport { i18n } from '../../i18n';\n\nimport './list';\n\nwindow.addEventListener('keydown', (e) => {\n  if (e.key.toLowerCase() === 'i') {\n    const id = Number(prompt('Enter NetEase Cloud Music ID:'));\n    if (id) changeSong(id);\n  }\n});\n\n@connectStore(store)\n@customElement('app-root')\nexport class SongList extends GemElement {\n  autoSelect = async () => {\n    const { cid } = await getOptions();\n    sendEvent(cid, events.autoSelectTrack);\n    changeSong(0);\n  };\n\n  // https://github.com/mantou132/Spotify-Lyrics/issues/105\n  // 不知道为什么第一次不能渲染内容\n  // 让他延时渲染内容就可以了\n  // ？？？？？？？？？？？？？？？？？？？？？？\n  #rendered = false;\n  mounted = () => {\n    setTimeout(() => {\n      this.#rendered = true;\n      this.update();\n    }, 200);\n  };\n  render() {\n    if (store.list.length === 0 && !store.id) {\n      return html`\n        <style>\n          :host {\n            box-sizing: border-box;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            padding: 1rem;\n            font-size: 1.5rem;\n            font-weight: 700;\n            text-align: center;\n          }\n        </style>\n        ${this.#rendered ? html`<slot></slot>` : ''}\n      `;\n    }\n    return html`\n      <style>\n        :host {\n          display: flex;\n          flex-direction: column;\n          font-weight: 400;\n        }\n        .header {\n          display: flex;\n          flex-shrink: 0;\n          padding: 1rem 0;\n          margin: 0 0.875rem;\n          border-bottom: 1px solid rgba(${theme.textRGB}, 0.2);\n          color: rgba(${theme.textRGB}, 0.5);\n        }\n        .header p {\n          margin: 0;\n          flex-grow: 1;\n        }\n        .highlight {\n          color: rgba(${theme.primaryRGB}, 1);\n        }\n        .header .button {\n          border-bottom: 1px dotted;\n        }\n        .header .button:hover {\n          cursor: default;\n          color: rgba(${theme.textRGB}, 1);\n        }\n        .header button {\n          background: transparent;\n          font-size: 0.75rem;\n          font-weight: 700;\n          padding: 0;\n          margin-left: 0.5rem;\n          line-height: 1rem;\n          letter-spacing: 0.1em;\n          border: none;\n          color: inherit;\n        }\n        .header button:hover {\n          color: rgba(${theme.textRGB}, 1);\n        }\n        .header button:focus {\n          outline: none;\n        }\n        .main {\n          overflow: auto;\n          flex-grow: 1;\n          scrollbar-width: none;\n        }\n        .main::-webkit-scrollbar {\n          display: none;\n        }\n      </style>\n      <div class=\"header\">\n        ${store.id && store.id !== store.aId\n          ? html`\n              <p class=\"highlight\">${i18n.popupConfirmTip()}</p>\n              <button @click=${cancelMId}>${i18n.popupConfirmCancel()}</button>\n              <button @click=${confirmedMId}>${i18n.popupConfirmSave()}</button>\n            `\n          : html`\n              <p>\n                ${i18n.popupMatchDescription1()}\n                <span @click=${this.autoSelect} class=\"button\">\n                  ${i18n.popupMatchDescription2()}\n                </span>\n                ${i18n.popupMatchDescription3()}\n              </p>\n            `}\n      </div>\n      <div class=\"main\">\n        <app-track-list class=\"list\"></app-track-list>\n      </div>\n    `;\n  }\n}\n","import { render, html } from '@mantou/gem';\n\nimport { theme } from '../common/theme';\nimport { fontStyle } from '../common/font';\nimport { sendEvent, events } from '../common/ga';\nimport { captureException } from '../common/bg';\nimport { getOptions } from '../options/store';\nimport { i18n } from '../i18n';\n\nimport './elements/root';\n\nfunction main(fontSize: number) {\n  render(\n    html`\n      ${fontStyle}\n      <style>\n        :root {\n          font-size: ${fontSize}px;\n        }\n        body {\n          box-sizing: border-box;\n          border: 1px solid rgba(${theme.textRGB}, 0.2);\n          width: 20rem;\n          height: 30rem;\n          margin: 0;\n          overflow: hidden;\n          background: rgb(${theme.backgroundRGB});\n          color: rgb(${theme.textRGB});\n          font-size: 1rem;\n        }\n        app-root {\n          height: 100%;\n        }\n      </style>\n      <app-root>${i18n.popupMissMatch()}</app-root>\n    `,\n    document.body,\n  );\n}\n\nconst getFontSize = () => {\n  return Number(localStorage.getItem('fontSize')) || 16;\n};\n\nconst setFontSize = (fontSize: number) => {\n  localStorage.setItem('fontSize', String(fontSize));\n  main(fontSize);\n};\n\nmain(getFontSize());\n\nwindow.addEventListener('keydown', (evt) => {\n  const { key, ctrlKey, metaKey } = evt;\n  if (!ctrlKey && !metaKey) return;\n  const scale = (n: number) => {\n    evt.preventDefault();\n    setFontSize(getFontSize() * n);\n  };\n  if (key === '=' || key === '+') {\n    scale(1.2);\n  }\n  if (key === '-') {\n    scale(1 / 1.2);\n  }\n});\n\nsetTimeout(() => {\n  // fix firefox overflow menu\n  if (matchMedia('(min-width: 20.001rem)').matches) {\n    document.body.style.width = '100%';\n  }\n}, 200);\n\ngetOptions().then(({ cid }) => {\n  sendEvent(cid, events.openPopupPage);\n});\n\nwindow.addEventListener('error', (e) => {\n  captureException(e);\n});\n"],"names":["name","__decorateClass","SongList"],"mappings":"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"}